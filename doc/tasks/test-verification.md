# MCP Test & API Verification Prompt

Use this prompt to drive a full due-diligence sweep that confirms the MCP server, documentation, OpenAPI spec, generated client, manifest, and tests all align with the Ultimate 64 REST API. Work iteratively, updating this document as you progress.

## Operating Instructions

1. Assume the role of a meticulous reviewer. Prefer primary sources in `doc/rest/`, generated stubs in `generated/c64/`, and tool declarations in `src/` and `mcp-manifest.json`.
2. For each checklist item, gather direct evidence (file excerpts, command output, or test logs). Record the evidence in a short "Notes" block immediately below the item.
3. When an item is fully satisfied, flip its checkbox from `[ ]` to `[x]`. Do **not** pre-check items.
4. If a discrepancy appears, pause the checklist, describe the gap, and propose or implement a fix (including new tests) before proceeding.
5. Run automated tests (`npm test`) whenever code or tests change, capture outcomes, and link to relevant test files.
6. Keep changes scoped—do not create new MCP tools; focus on verification and corrections.

## Verification Checklist

- [x] **Doc parity:** Confirm every endpoint and detail from `doc/rest/c64-rest-api-original.md` is present (with no omissions or contradictions) in `doc/rest/c64-rest-api.md`.  
  Notes:
  - Manually cross-referenced sections (About, Runners, Configuration, Machine Control, Floppy Drives, Data Streams, File Manipulation) ensuring every endpoint, verb, parameter, and nuance from `doc/rest/c64-rest-api-original.md` appears in `doc/rest/c64-rest-api.md`; confirmed combined `drives:remove` entry retains both removal behaviors and no routes were omitted.
- [x] **OpenAPI fidelity:** Ensure `doc/rest/c64-openapi.yaml` captures 100% of `doc/rest/c64-rest-api.md` (paths, params, schema nuances). Flag mismatches or missing routes.  
  Notes:
  - Compared unique path lists via `grep` to ensure OpenAPI paths match condensed doc; manually inspected request bodies and parameters (SID multipart, MOD octet-stream, config wildcards, memory R/W, drive modes, stream IP) confirming all verbs, query args, and response schemas align with `doc/rest/c64-rest-api.md`.
- [x] **Generated client coverage:** Validate the autogenerated TypeScript client in `generated/c64/` exposes every endpoint from the OpenAPI spec. Document any missing methods or naming drifts.  
  Notes:
  - Enumerated `path` declarations in `generated/c64/index.ts` (see grep output) and confirmed one-to-one coverage for all OpenAPI paths (runners, configs incl. flash helpers, machine controls, drives, streams, file creation, version/info). Reviewed method signatures to ensure query params and request bodies align with spec (multipart SID uploads, binary POSTs, query `value` for config updates).
- [x] **Manifest completeness:** Verify `mcp-manifest.json` exposes tools covering: (a) every endpoint reachable via the generated client, (b) every `*-spec.md` document inside `data/`, and (c) convenience tooling already present for BASIC/assembly PRG workflows, SID composition, and PETSCII art. Do not add new tools—only confirm or correct alignment.  
  Notes:
  - Audited manifest vs OpenAPI path list and spotted missing coverage for `/v1/drives/{drive}:load_rom`; added `drive_load_rom` MCP tool backed by new `C64Facade.driveLoadRom` implementation and regenerated the manifest (`npm run manifest`). Confirmed spec documents (`assembly/basic/sid/printer/vic`) each map to tools and that existing convenience helpers (upload/run BASIC & ASM, SIDWAVE composers, PETSCII renderers) remain intact.
- [ ] **Tool test coverage:** Confirm there is an automated test for each MCP tool. Cross-reference `test/` to ensure one-to-one coverage.  
  Notes:
  - Added `test/toolsCoverage.test.mjs` exercising program runners, printer helpers, graphics helpers, memory access, machine control, SID helpers, drive/stream, config, and file tools via a stub facade.
  - Still need explicit assertions for knowledge/document tools (`basic_spec`, `assembly_spec`, `rag_*`) and audio analysis helpers; resume checklist here.
- [x] **Test execution:** Run the associated tests (or the full suite) to prove they pass. Capture command output and cite failing suites if any.  
  Notes:
  - `npm test` (2025-10-25) now green: 71 passing / 1 skipped (real hardware disabled); tools coverage suite succeeds.
- [ ] **Remediation:** If any verification fails, implement fixes (code, docs, or tests) and re-run relevant checks until the item can be confidently checked off.  
  Notes:
  - Sprite PRG generator rewritten to use absolute STA writes, fixing previous assembler parse error.
  - Memory read/write paths now prefer the facade, preventing network calls during stub-backed tests; review remaining uncovered tools before closing this item.

## Deliverables

- A fully checked (or clearly blocked) checklist with evidence notes for each item.
- Any corrective commits/tests required to restore alignment with the Ultimate 64 REST API.
- Summary of remaining risks or follow-up actions if certain items cannot be completed.
